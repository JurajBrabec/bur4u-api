var Pe=Object.defineProperty;var Se=(e,t,s)=>t in e?Pe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var u=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var S=(e,t,s)=>(Se(e,typeof t!="symbol"?t+"":t,s),s);var wt=u((Os,mt)=>{mt.exports=require("../src/modules.js")});var _t=u((Ls,gt)=>{var{apicache:Ae,express:R,fileUpload:De,cors:Ie,morgan:ft,rfs:yt}=require("../src/modules.js");gt.exports=({moduleName:e,cacheTime:t,logPath:s,logRotation:r,root:o,routes:a,ui:n})=>{let i=R();return t&&i.use(Ae(t)),i.use(De({createParentPath:!0})),i.use(Ie()),i.use(R.json({limit:"8mb"})),i.use(R.urlencoded({extended:!0,limit:"8mb"})),s&&(i.use(ft("combined",{stream:yt.createStream(`${e}-access.log`,{interval:r,path:s})})),i.use(ft("combined",{skip:(c,d)=>d.statusCode<201,stream:yt.createStream(`${e}-security.log`,{interval:"1M",maxFiles:12,path:s})}))),n&&i.use("/ui",R.static("ui")),i.use(o,a),i.use((c,d)=>d.sendStatus(501)),i}});var G=u((Hs,N)=>{var kt=require("https"),{access:Re,readFile:Ne}=require("fs").promises,{hostname:Fe}=require("os"),{fetch:xt}=require("../src/modules.js"),bt=new kt.Agent({rejectUnauthorized:!1}),vt="./cert",Tt=[".crt",".key"],Et=`${vt}/cert`,qt=`${vt}/${Fe()}`,Ct=async e=>{try{return await Promise.all(Tt.map(t=>Re(e+t))),!0}catch{return!1}};N.exports.create=async({app:e,port:t,callBack:s})=>{let r;if(await Ct(Et)&&(r=Et),await Ct(qt)&&(r=qt),!r)throw new Error("No certificates found");let[o,a]=await Promise.all(Tt.map(i=>Ne(r+i))),n={cert:o,key:a};return kt.createServer(n,e).listen(t,s)};N.exports.get=(e,t)=>xt(`https://${e}`,{agent:bt,headers:{Authorization:`Bearer ${t}`}});N.exports.post=(e,t,s)=>xt(`https://${e}`,{agent:bt,body:JSON.stringify(s),headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},method:"POST"})});var F=u((Bs,X)=>{var $t=()=>new Date().toLocaleString("en-GB").replace(", ","-");X.exports.stdout=e=>console.log($t(),":",e);X.exports.stderr=e=>console.error($t(),"!",e)});var A=u((C,k)=>{var{watch:Ue,rename:Oe,readdir:Le,readFile:He,writeFile:Be,access:Me}=require("fs/promises"),{md5File:We}=require("../src/modules.js"),Ye="change",q="bur4u-api.js",ze=1,K=".",Je=/dev|test/.test(process.env.npm_lifecycle_event),jt,Pt;Me(`./${q}`).then(()=>We(`./${q}`)).then(e=>Pt=e).catch(()=>console.log("DEV:",Je));var St=class{constructor({name:t,buffer:s,md5:r}){this.buffer=s,this.name=t,this.md5=r}mv(t){return Be(t,this.buffer)}},At=(e,t)=>`${e}-${t}.update`,Dt=e=>new RegExp(`^${At(e,".+")}$`);k.exports.File=St;k.exports.handle=(e,{eventType:t,filename:s})=>{jt||t===Ye&&(!s.match(Dt(e))||(jt=setTimeout(()=>C.update(s),5e3)))};k.exports.json=async()=>{let e=await He(`./${q}`,"utf8"),t=q,s=C.md5();return{buffer:e,name:t,md5:s}};k.exports.md5=()=>Pt;k.exports.update=e=>{Oe(e,`./${q}`).then(()=>{console.log("Update finished."),process.exit(ze)}).catch(t=>console.error(t))};k.exports.upload=(e,t)=>{if(t.name!==q)throw new Error("Invalid file name");if(t.md5===C.md5())throw new Error("File has not changed");t.mv(`${K}/${At(e,t.md5)}`)};k.exports.watch=async(e="")=>{let t=await Le(K);for(let r of t)r.match(Dt(e))&&C.update(r);let s=Ue(K);for await(let r of s)C.handle(e,r);return s}});var Nt=u((Ws,Rt)=>{var{nJwt:It}=require("../src/modules.js"),Ve=e=>new Date(new Date().setFullYear(new Date().getFullYear()+e));Rt.exports=class{constructor({claims:t={iss:"*",sub:"*",aud:"*"},secret:s="*",validYears:r=1}={}){this.claims=t,this.secret=s,this.validYears=r}getToken(t={}){let s={...this.claims,...t},r=It.create(s,this.secret);return delete r.body.jti,r.setExpiration(Ve(this.validYears)),r.compact()}validateToken(t,s={}){try{let{body:r}=It.verify(t,this.secret),o={...this.claims,...s},a;if(r.iss!==o.iss&&(a="issuer mismatch"),r.sub!==o.sub&&(a="subject mismatch"),r.aud!==o.aud&&(a="audience mismatch"),a)throw new Error(a);return{id:t,isValid:!0,...r}}catch(r){return{id:t,isValid:!1,error:r.message}}}reqToClaims(t){return{}}middleWare(){return(async(s,r,o)=>{let a;try{let n,i=s.headers.authorization;if(i||(n="authorization header required"),!n&&!i.startsWith("Bearer ")&&(n="invalid authorization header"),!n){let c=i.split(" ").pop();if(a=await this.validateToken(c,this.reqToClaims(s)),a.isValid)return s.token=a,o();n=a.error}r.status(401).send(`Auth error: ${n}`)}catch(n){r.status(500).send(`Auth error: ${n.message}`)}}).bind(this)}}});var U=u((Ys,Ut)=>{var Ge=Nt(),Ft=class extends Ge{getToken(t){let s=this.reqToClaims(t);return super.getToken(s)}reqToClaims(t){return{sub:t.hostname}}setIssuer(t){this.claims.iss=t}},Q;Q||(Q=new Ft({claims:{iss:"bur4u-api",aud:"bur4u-api"},secret:"dxc.technology",validYears:1}));Ut.exports=Q});var Lt=u((zs,Ot)=>{var{Cached:Xe,NBU:Ke}=require("../src/modules.js"),Qe=U(),D=F(),Ze=Xe.depot("config"),ts=(e,t)=>{let s=()=>{let r=e.shift();return r?Promise.allSettled([r()]).then(()=>s()):null};return Promise.all(Array.from({length:t},s))};Ot.exports.init=async({nbuBinPath:e,domain:t,user:s,password:r,cacheInterval:o,cacheConcurrency:a})=>{let n=s?{domain:t,user:s,password:r}:void 0;try{let i=await Ke({bin:e,credentials:n});Qe.setIssuer(i.masterServer),console.log(`Started NBU integration with ${i.masterServer}.`);let c=async()=>{let d=0;D.stdout("Caching of clients started...");try{let f=await i.clients(),P=f.map((E,J)=>async()=>Ze.set(E.name,async()=>{let _;try{let V=new Date().getTime();d++,_=await i.config({client:E.name});let pt=((new Date().getTime()-V)/1e3).toFixed(1);pt>10&&(D.stdout(`${J+1}/${f.length} ${E.name} ${_[0].versionName?"OK":_[0].clientMaster} (${pt}s)`),d>1&&d<a&&D.stdout(`${d-1} remaining...`))}catch(V){D.stderr(`Error caching ${E.name}: ${V.message}`)}return d--,_}));await ts(P,a),D.stdout(`Successfuly cached ${f.length} clients.`)}catch(f){throw new Error(`caching clients: ${f.message}`)}};await c(),setInterval(c,o*1e3)}catch(i){throw new Error(`starting NBU integration: ${i.message}`)}}});var tt=u((Js,Bt)=>{var{version:es}=require("../src/modules.js"),Z=class{constructor(){this.timeStamp=Date.now(),this.version=es}},Ht=class extends Z{constructor(t){super();this.error=t.message||t}};Bt.exports={Response:Z,Error:e=>new Ht(e)}});var Zt=u((Vs,Qt)=>{var{Response:O,Error:ss}=tt(),Mt=class extends O{constructor(t){super();this.clients=t}},Wt=class extends O{constructor(t,s,r){super();this.settings=t,this.activeJobs=s,this.policies=r}},Yt=class extends O{constructor(t){super();this.jobs=t}},zt=class extends O{constructor(t,s){super();this.settings=t,this.backupTypes=s}},Jt=class{constructor(t){this.name=t.name,this.architecture=t.architecture,this.os=t.os,this.settings=t.settings}},Vt=class{constructor(t){this.jobId=t.jobId,this.parentJob=t.parentJob,this.status=t.status,this.jobType=t._.jobType,this.subType=t._.subType,this.state=t._.state,this.policy=t.policy,this.policyType=t._.policyType,this.schedule=t.schedule,this.scheduleType=t._.scheduleType,this.started=t._.started,this.elapsed=t._.elapsed,this.retention=t._.retentionLevel}},Gt=class{constructor(t){this.name=t.name,this.backupType=t._.backupType,this.frequency=t._.frequency,this.retention=t._.retentionLevel,this.calendar=t.calendar,this.copies=t.copies,this.calDayOfWeek=t.calDayOfWeek,this.schedRes=t.schedRes,this.schedRL=t.schedRL,this.win_sun_start=t._.win_sun_start,this.win_sun_duration=t._.win_sun_duration,this.win_mon_start=t._.win_mon_start,this.win_mon_duration=t._.win_mon_duration,this.win_tue_start=t._.win_tue_start,this.win_tue_duration=t._.win_tue_duration,this.win_wed_start=t._.win_wed_start,this.win_wed_duration=t._.win_wed_duration,this.win_thu_start=t._.win_thu_start,this.win_thu_duration=t._.win_thu_duration,this.win_fri_start=t._.win_fri_start,this.win_fri_duration=t._.win_fri_duration,this.win_sat_start=t._.win_sat_start,this.win_sat_duration=t._.win_sat_duration}},Xt=class{constructor(t){this.name=t.name,this.state=t.active?"Disabled":"Enabled",this.backupCopy=t.backupCopy,this.backupCopies=t.backupCopies,this.res=t.res,this.include=t.include,this.policyType=t._.policyType,this.jobSubtype=t._.jobSubtype,this.clients=t.clients,this.schedules=t.schedules.map(s=>new Gt(s))}},Kt=class{constructor(t){this.name=t.slpName,this.operationIndex=t.operationIndex,this.useFor=t._.useFor,this.retention=t._.retentionLevel,this.window=t.slpWindow,this.storageUnit=t.storageUnit}};Qt.exports={Error:ss,Client:e=>new Jt(e),ClientHistory:e=>new Yt(e),ClientDetail:(e,t,s)=>new Wt(e,t,s),ClientConfiguration:(e,t)=>new zt(e,t),Clients:e=>new Mt(e),Job:e=>new Vt(e),Policy:e=>new Xt(e),SLP:e=>new Kt(e)}});var ne=u((Gs,nt)=>{var rs=e=>Array.from(new Set(e)).join(","),L,I,et,st=e=>!e.name.match(/(DUMMY|TEMPLATE|_\d+Y_)/),te=e=>e.name.match(/_\d+Y_/),ns=e=>e._.frequency.match(/\d\d hours/),ee=e=>e.calendar===1,os=e=>rs(e.map(t=>t.include)),as=e=>e==="Full"?"Premium":"Standard",is=e=>e.match(/^(Any|18|19|20)/)?"18:00-06:00":"21:00-09:00",H=(e,t,s)=>e.reduce((r,o)=>o.slpName===t&&o._.useFor===s?o._.retentionLevel:r,null),se=(e,t,s)=>{let[r]=e.filter(o=>o.policy===t&&o._.scheduleType===s).sort((o,a)=>a.started-o.started);return r?{jobId:r.jobId,started:r._.started,status:r.status}:null},cs=(e,t,s)=>{let{schedRes:r}=s,{backupType:o,frequency:a,retentionLevel:n}=s._,i=se(et,e,o),c=Array.from(new Set([s._.win_sun_start,s._.win_mon_start,s._.win_tue_start,s._.win_wed_start,s._.win_thu_start,s._.win_fri_start,s._.win_sat_start])).join(",");return{model:as(o),frequency:a,type:o,encryption:!0,timeWindow:is(c),startTime:c,backupRetention:H(I,r||t,"Backup")||n,copyRetention:H(I,r||t,"Duplication")||null,lastJob:i}},re=(e,t,s)=>{let{schedRes:r}=s,{backupType:o,frequency:a,retentionLevel:n,calDates:i,calDayOfWeek:c}=s._,d=se(et,e,o);return{frequency:a,calendar:s.calDayOfWeek,copyWeekend:c,startTime:i,backupRetention:H(I,r||t,"Backup")||n,copyRetention:H(I,r||t,"Duplication")||null,lastJob:d}},rt=(e,t,s)=>{let r=new Set;return e.forEach(({name:o,active:a,res:n,schedules:i})=>i.filter(t).map(c=>s(o,n,c)).map(c=>r.add({state:a?"Disabled":"Enabled",...c}))),r=Array.from(r),r.length?r:null},us=e=>({name:e[0]._.policyType,includes:os(e),daily:rt(e.filter(st),ns,cs),monthly:rt(e.filter(st),ee,re),yearly:rt(e.filter(te),ee,re)});nt.exports.settings=e=>e?e[0]:{};nt.exports.backupTypes=(e,t,s,r)=>{L=t.filter(n=>n.clients.find(i=>i.name===e)).filter(n=>st(n)||te(n)).sort((n,i)=>n.name<i.name?-1:1);let o=new Set(L.reduce((n,i)=>(n.push(i.res,...i.schedules.map(c=>c.schedRes)),n),[]));I=s.filter(n=>o.has(n.slpName)).sort((n,i)=>n.name<i.name?-1:1),et=r.filter(n=>n.client===e).sort((n,i)=>i.started-n.started);let a=[];return new Set(L.map(n=>n._.policyType)).forEach(n=>a.push(us(L.filter(i=>i._.policyType===n)))),a}});var oe=u((Xs,w)=>{var{Cached:ds,NBU:B,version:ls}=require("../src/modules.js"),l=Zt(),hs=U(),{settings:ot,backupTypes:ps}=ne(),at=A(),it=ds.depot("config");w.exports.version=(e,t)=>t.status(200).json({version:ls});w.exports.options=(e,t,s)=>{t.header("Access-Control-Allow-Methods","GET"),t.header("Access-Control-Allow-Headers","Content-Type, Authorization"),t.sendStatus(200)};w.exports.token=async(e,t)=>{try{t.send(hs.getToken(e))}catch(s){t.status(500).json(l.Error(s))}};w.exports.client=async(e,t)=>{try{let{hostName:s}=e.params,r=await B(),[o,a]=await Promise.all([r.jobs({daysBack:1}),r.policies()]),n=it.get(s);t.json(l.ClientDetail(ot(n),o.filter(i=>i.state===1&&i.client===s).sort((i,c)=>i.jobId>c.jobId).map(l.Job),a.filter(i=>i.clients.reduce((c,d)=>(d.name===s&&(c=!0),c),!1)).sort((i,c)=>i.name<c.name).map(l.Policy)))}catch(s){t.status(500).json(l.Error(s))}};w.exports.clients=async(e,t)=>{try{let o=(await(await B()).clients()).map(a=>(a.settings=ot(it.get(a.name)),a));t.json(l.Clients(o.map(l.Client)))}catch(s){t.status(500).json(l.Error(s))}};w.exports.history=async(e,t)=>{try{let{hostName:s}=e.params,o=await(await B()).jobs({daysBack:7});t.json(l.ClientHistory(o.filter(a=>a.state===3&&a.client===s).sort((a,n)=>a.jobId>n.jobId).map(l.Job)))}catch(s){t.status(500).json(l.Error(s))}};w.exports.configuration=async(e,t)=>{try{let{hostName:s}=e.params,r=await B(),[o,a,n]=await Promise.all([r.policies(),r.slps(),r.jobs({daysBack:7})]),i=it.get(s);t.json(l.ClientConfiguration(ot(i),ps(s,o,a,n)))}catch(s){t.status(500).json(l.Error(s))}};w.exports.md5=(e,t)=>t.send(at.md5());w.exports.update=(e,t)=>{try{if(!e.body)throw new Error("No files were uploaded.");let s=new at.File(e.body);at.upload("api",s),t.sendStatus(200)}catch(s){t.status(400).json(l.Error(s))}}});var ce=u((Ks,ie)=>{var{express:ms}=require("../src/modules.js"),ae=U(),y=oe(),p=ms.Router();p.options(y.options);p.use("/token",y.token);p.get("/version",y.version);p.use("/clients",ae.middleWare());p.get("/clients/:hostName/configuration",y.configuration);p.get("/clients/:hostName/history",y.history);p.get("/clients/:hostName",y.client);p.get("/clients",y.clients);p.use("/script",ae.middleWare());p.get("/script/md5",y.md5);p.post("/script/update",y.update);ie.exports=p});var ct=u((Qs,pe)=>{var{Response:ue,Error:ws}=tt(),de=class extends ue{constructor(t){super();this.name=t.addr.split(":").shift(),this.status=t.status,this.data=t.data}},le=class extends ue{constructor(t){super();this.providers=t}},he=class{constructor(t){this.addr=t.addr,this.api_token=t.api_token,this.public_key=t.public_key,this.name=t.addr.split(":").shift(),this.status=t.status,this.version=t.version,this.data=t.data}};pe.exports={Error:ws,Entry:e=>new he(e),Provider:e=>new de(e),Providers:e=>new le(e)}});var we=u((tr,me)=>{me.exports=class{constructor(){this.cache=new Map}purge(){let t=new Date;return this.cache.forEach((s,r)=>{s.expiresAt<t&&this.cache.delete(r)}),this}get(t){return this.purge(),this.cache.has(t)?this.cache.get(t):null}set(t,s){let r=new Date;return this.cache.set(t,{...s,cached:r})}}});var ye=u((sr,fe)=>{var fs=we(),ys=e=>new Date(new Date().setFullYear(new Date().getFullYear()+e));fe.exports=class{id;endPoint;constructor({id:t,endPoint:s="localhost",useCache:r=!0,validYears:o=1,authHeader:a="x-auth-token"}={}){this.id=t,this.id&&(this._token=this.makeToken({id:this.id,expires:ys(o)})),this.endPoint=s,this.authHeader=a,r&&(this.cache=new fs,this._token&&this.cache.set(this.id,this._token))}makeToken({id:t,isValid:s=!0,issued:r=new Date,expires:o=new Date,error:a}={}){let n={id:t,isValid:s,issued:r,expires:o};return a&&(n.isValid=!1,n.error=a.message||a,delete n.issued,delete n.expires),n}Url(t="localhost"){return`https://${t}`}isAuthorized(t){return t}async tokenId(){return this.id}async fetchTokenId(){return this.id}async fetchToken(t){return{status:200,header:t,body:{}}}async token(t){let s=Date.now(),r;try{if(!t)throw new Error("token missing");if(this.cache?r=this.cache.get(t):t===this.id&&(r=this._token),!r){let{status:o,header:a,body:n}=await this.fetchToken(t);if(o!==200)throw n.error;if(!this.isAuthorized(n.token))throw new Error("token not authorized");if(t!==a)throw new Error("token mismatch");r=this.makeToken({id:t,issued:new Date(n.token.issued_at),expires:new Date(n.token.expires_at)}),this.cache&&this.cache.set(t,r)}}catch(o){r=this.makeToken({id:t,error:o})}return r.time=Date.now()-s,r}middleWare(){return(async(s,r,o)=>{try{let a=s.headers[this.authHeader],n=await this.token(a);if(n.isValid)return s.token=n,o();r.status(401).send(`Auth error: ${n.error}`)}catch(a){r.status(500).send(`Auth error: ${a.message}`)}}).bind(this)}}});var M=u((rr,_e)=>{var gs=require("https"),{fetch:ge}=require("../src/modules.js"),_s=ye(),x=class extends _s{constructor({id:t,environment:s,authHeader:r,authSubjectHeader:o,isAuthorized:a,useCache:n=!0}={}){let i;x.environments.has(s)&&(i=x.endPoints.get(s));super({id:t,endPoint:i,authHeader:r,useCache:n});this.environment=s,this.authSubjectHeader=o,this.agent=new gs.Agent({rejectUnauthorized:!1}),a&&(this.isAuthorized=a)}AuthBody(){let{name:t,password:s}=x.testUsers.get(this.environment);return{auth:{identity:{methods:["password"],password:{user:{domain:{name:"VPC_Consumer"},name:t,password:s}}},scope:{project:{name:"VPC_BUR4U_API",domain:{name:"VPC_Services"}}}}}}setEnvironment(t){x.environments.has(t)&&(this.environment=t,this.endPoint=x.endPoints.get(t))}Url(t){return`https://${t}:35357/v3/auth/tokens?nocatalog`}async tokenId(){return this.fetchTokenId()}async fetchTokenId(){let t=this.Url(this.endPoint),s="POST",r={accept:"application/json","content-type":"application/json"},o=JSON.stringify(this.AuthBody()),a=this.agent,n;try{let i=await ge(t,{method:s,headers:r,body:o,agent:a});if(i.status!==201)throw new Error(`${i.status} ${i.statusText}`);n=i.headers.raw()[this.authSubjectHeader][0]}catch(i){n={status:"Error",error:i.message||i}}return n}async fetchToken(t){let s=this.Url(this.endPoint),r={accept:"application/json","content-type":"application/json"};r[this.authHeader]=t,r[this.authSubjectHeader]=t;let o=this.agent,a=await ge(s,{headers:r,agent:o}),{status:n}=a,i=n===200?a.headers.raw()[this.authSubjectHeader][0]:null,c=await a.json();return{status:n,header:i,body:c}}},v=x;S(v,"endPoints",new Map([["FT1","pln-cd1-apigw-vip.ft1core.mcloud.entsvcs.net"],["FT2","pln-ce1-itokenv.ft2core.mcloud.entsvcs.net"],["STAGE","tub-crs1-iapig.mcloud.entsvcs.com"],["PROD","atcswa-cr-iapig.mcloud.entsvcs.com"]])),S(v,"environments",new Set(x.endPoints.keys())),S(v,"testUsers",new Map([["FT1",{name:"ngp_bur_user",password:"tadrur!9-iV_!55I2lFr"}],["PROD",{name:"juraj.brabec@dxc.com",password:"5=F42*f*b0samew?tHi$"}]])),S(v,"isAuthorized",t=>t.roles.reduce((s,r)=>s||r.name==="bur4u_api_consumer",!1));var ut;ut||(ut=new v({id:"2242189293e5412ba71a8f2086a3ef0c",environment:"FT1",authHeader:"x-auth-token",authSubjectHeader:"x-subject-token",isAuthorized:v.isAuthorized,useCache:!0}));_e.exports=ut});var Y=u((W,T)=>{var dt=G(),ke=ct(),ks=M(),lt=F(),xe=A(),$;$||($=[]);T.exports.get=()=>$;T.exports.resolve=function(e,t,s){let r=e.params.hostName;e.providers=$.filter(o=>o.status==="OK").map(o=>o.data.clients.find(a=>!r||a.name===r)?o:null).filter(o=>o),s()};T.exports.read=async(e,t)=>{try{await W.update(e,t);let s=await Promise.all(t.map(r=>W.query(r,`${e}/clients`)));$=t.map((r,o)=>{let{timeStamp:a,status:n,data:i}=s[o],c=i?.version;return ke.Entry({...r,timeStamp:a,status:n,version:c,data:i})})}catch(s){lt.stderr(`Error importing providers: ${s.message}`)}return $};T.exports.query=async(e,t)=>{let{addr:s,api_token:r}=e,o=null,a=null;try{let n=await dt.get(`${s}${t}`,r);a=n.statusText,n.status===200&&(o=await n.json()),n.status===401&&(a=await n.text())}catch(n){a=n.code||n.message||n}return ke.Provider({...e,data:o,status:a})};T.exports.init=async({root:e,providers:t,queryInterval:s,tsaEnv:r})=>{r&&ks.setEnvironment(r);let o=async()=>{try{await W.read(e,t),lt.stdout(`Imported ${t.length} providers.`)}catch(a){throw new Error(`importing providers: ${a.message}`)}};await o(),setInterval(o,s*1e3)};T.exports.update=async(e,t)=>{let s=xe.md5();s&&t.forEach(async r=>{try{let o,{addr:a,api_token:n}=r;o=await dt.get(`${a}${e}/script/md5`,n);let i=await o.text();if(console.log(i),i===s)return;let c=await xe.json();o=await dt.post(`${a}${e}/script/update`,n,c),console.log(await o.text())}catch(o){lt.stderr(`Error updating provider ${r.addr}: ${o.message}`)}})}});var Te=u((nr,g)=>{var{version:xs}=require("../src/modules.js"),b=ct(),ht=Y(),be=M(),ve=A();g.exports.version=(e,t)=>t.status(200).json({version:xs});g.exports.options=(e,t,s)=>{t.header("Access-Control-Allow-Methods","GET"),t.header("Access-Control-Allow-Headers","Content-Type, X-Auth-Token, X-Subject-Token"),t.sendStatus(200)};g.exports.token=async(e,t)=>{if(e.query.hasOwnProperty("local"))return t.send(be.id);try{let s=await be.tokenId();t.send(s)}catch(s){t.status(400).json(b.Error(s))}};g.exports.provider=async(e,t)=>{try{let{hostName:s}=e.params;t.json(b.Provider(ht.get().filter(r=>r.name===s).shift()))}catch(s){t.status(400).json(b.Error(s))}};g.exports.providers=async(e,t)=>{try{t.json(b.Providers(ht.get().map(s=>{let{timeStamp:r,name:o,status:a,version:n}=s,i=s.data?.clients?.length||0;return{timeStamp:r,name:o,status:a,version:n,clients:i}})))}catch(s){t.status(400).json(b.Error(s))}};g.exports.proxy=(e,t)=>Promise.all(e.providers.map(s=>ht.query(s,e.originalUrl))).then(s=>t.json(b.Providers(s))).catch(s=>t.status(400).json(b.Error(s)));g.exports.md5=(e,t)=>t.send(ve.md5());g.exports.update=(e,t)=>{try{if(!e.files)throw new Error("No files were uploaded.");let{file:s}=e.files;ve.upload("proxy",s),t.sendStatus(200)}catch(s){t.status(400).json(b.Error(s))}}});var Ce=u((or,qe)=>{var{express:bs}=require("../src/modules.js"),z=Y(),m=Te(),Ee=M(),h=bs.Router();h.options(m.options);h.use("/token",m.token);h.get("/version",m.version);h.use("/providers",Ee.middleWare());h.get("/providers",m.providers);h.get("/providers/:hostName",m.provider);h.use("/clients",Ee.middleWare());h.get("/clients/:hostName/configuration",z.resolve,m.proxy);h.get("/clients/:hostName/history",z.resolve,m.proxy);h.get("/clients/:hostName",z.resolve,m.proxy);h.get("/clients",z.resolve,m.proxy);h.get("/script/md5",m.md5);h.post("/script/update",m.update);qe.exports=h});var{configurator:j,description:vs,version:Ts}=wt(),Es=_t(),qs=G(),$e=F(),Cs=A(),je="/api/v1",$s="15 seconds",js="1d",Ps="api",Ss="proxy",As=28748,Ds="conf/bur4u-api.config.js",Is=60*60*12,Rs=8,Ns=60;try{console.log(`${vs} v${Ts}`);let e=j.expect.jsFile({configFile:{arg:"config",default:Ds}}).string({moduleName:{arg:"module",required:!0,do:_=>_.toLowerCase()}}).string({cacheTime:{arg:"cache",default:$s}}).path({logPath:{arg:"log"}}).string({logRotation:{arg:"logrot",default:js}}).num({port:{default:As}}).save(),t=j.expect.new().path({nbuBinPath:{arg:"bin",required:!0}}).string("domain").string("user").string("password").num({cacheInterval:{arg:"interval",default:Is}}).num({cacheConcurrency:{arg:"concurrency",default:Rs}}).save(),s=j.expect.new().array({providers:{arg:"list",default:[]}}).num({queryInterval:{arg:"interval",default:Ns}}).string("tsaEnv").bool("ui").save(),{moduleName:r,cacheTime:o,logPath:a,logRotation:n,port:i,ui:c}=j.compile(e),d,f,P;switch(r){case Ps:d=Lt(),f=j.compile(t),P=ce();break;case Ss:d=Y(),f={root:je,...j.compile(s)},P=Ce();break;default:throw new Error(`wrong parameter --module '${r}'.`)}d.init(f).catch(_=>{$e.stderr(`Initialization error ${_.message}`),process.exit(1)}),Cs.watch(r);let E=Es({moduleName:r,cacheTime:o,logPath:a,logRotation:n,root:je,routes:P,ui:c}),J=()=>console.log(`${r.toUpperCase()} module ready (https://localhost:${i})`);qs.create({app:E,port:i,callBack:J})}catch(e){$e.stderr(`Error ${e.message}`),process.exit(1)}
